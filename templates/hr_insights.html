{% extends "base.html" %}

{% block title %}Unified HR Insights Dashboard - AI-Powered HR Platform{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="display-5 mb-4">
            <i class="fas fa-chart-bar me-3"></i>Unified HR Insights Dashboard
        </h1>
        <p class="lead text-muted">Comprehensive analytics and metrics for strategic HR decision-making</p>
    </div>
</div>

<!-- Key Metrics -->
<div class="row mb-5">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary">
            <div class="card-body text-center">
                <i class="fas fa-users fa-2x mb-2"></i>
                <h3 class="card-title">{{ insights.total_employees }}</h3>
                <p class="card-text">Total Employees</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-success">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <h3 class="card-title">{{ insights.avg_performance }}</h3>
                <p class="card-text">Avg Performance</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-info">
            <div class="card-body text-center">
                <i class="fas fa-graduation-cap fa-2x mb-2"></i>
                <h3 class="card-title">{{ insights.learning_completion_rate }}%</h3>
                <p class="card-text">Learning Completion</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-warning">
            <div class="card-body text-center">
                <i class="fas fa-smile fa-2x mb-2"></i>
                <h3 class="card-title">{{ "%.1f"|format(insights.engagement_score) }}</h3>
                <p class="card-text">Engagement Score</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row mb-5">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-building me-2"></i>Department Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="departmentChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-heart me-2"></i>Employee Wellness Status
                </h5>
            </div>
            <div class="card-body">
                <canvas id="wellnessChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Attrition Trends -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-user-minus me-2"></i>Attrition Trends (Last 6 Months)
                </h5>
            </div>
            <div class="card-body">
                <canvas id="attritionChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Diversity & Inclusion -->
<div class="row mb-5">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-venus-mars me-2"></i>Gender Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="genderChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>Age Group Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="ageChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Performance Insights -->
<div class="row mb-5">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-trophy me-2"></i>Performance Insights
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6 class="text-success">Top Performing Departments</h6>
                        <div class="list-group list-group-flush">
                            {% for dept, count in insights.departments.items() %}
                            {% if loop.index <= 3 %}
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span>{{ dept }}</span>
                                <span class="badge bg-success">{{ count }} employees</span>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6 class="text-info">Wellness Highlights</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="text-success fw-bold fs-5">{{ insights.wellness_distribution.green or 0 }}</div>
                                <small class="text-muted">Excellent</small>
                            </div>
                            <div class="col-4">
                                <div class="text-warning fw-bold fs-5">{{ insights.wellness_distribution.yellow or 0 }}</div>
                                <small class="text-muted">Good</small>
                            </div>
                            <div class="col-4">
                                <div class="text-danger fw-bold fs-5">{{ insights.wellness_distribution.red or 0 }}</div>
                                <small class="text-muted">Needs Attention</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Action Items
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex align-items-center px-0">
                        <i class="fas fa-user-plus text-primary me-3"></i>
                        <div>
                            <div class="fw-bold">Recruitment</div>
                            <small class="text-muted">3 open positions</small>
                        </div>
                    </div>
                    <div class="list-group-item d-flex align-items-center px-0">
                        <i class="fas fa-graduation-cap text-info me-3"></i>
                        <div>
                            <div class="fw-bold">Training</div>
                            <small class="text-muted">5 pending completions</small>
                        </div>
                    </div>
                    <div class="list-group-item d-flex align-items-center px-0">
                        <i class="fas fa-heart text-warning me-3"></i>
                        <div>
                            <div class="fw-bold">Wellness</div>
                            <small class="text-muted">{{ insights.wellness_distribution.red or 0 }} employees need support</small>
                        </div>
                    </div>
                    <div class="list-group-item d-flex align-items-center px-0">
                        <i class="fas fa-star text-success me-3"></i>
                        <div>
                            <div class="fw-bold">Reviews</div>
                            <small class="text-muted">Quarterly reviews due</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analytics Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>Department Analytics
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm active" onclick="showAnalytics('overview')">Overview</button>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="showAnalytics('performance')">Performance</button>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="showAnalytics('wellness')">Wellness</button>
                </div>
            </div>
            <div class="card-body">
                <div id="analyticsOverview">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Department</th>
                                    <th>Employees</th>
                                    <th>Avg Performance</th>
                                    <th>Learning Progress</th>
                                    <th>Wellness Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dept, count in insights.departments.items() %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-building text-primary me-2"></i>
                                            <span class="fw-bold">{{ dept }}</span>
                                        </div>
                                    </td>
                                    <td>{{ count }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="me-2">{{ "%.1f"|format(insights.avg_performance) }}</span>
                                            <div class="progress" style="width: 60px; height: 8px;">
                                                <div class="progress-bar bg-success" style="width: {{ insights.avg_performance * 10 }}%"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ insights.learning_completion_rate }}%</span>
                                    </td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            <span class="badge bg-success">{{ (insights.wellness_distribution.green or 0) // (insights.departments|length) }}</span>
                                            <span class="badge bg-warning">{{ (insights.wellness_distribution.yellow or 0) // (insights.departments|length) }}</span>
                                            <span class="badge bg-danger">{{ (insights.wellness_distribution.red or 0) // (insights.departments|length) }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-outline-primary btn-sm" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-success btn-sm" title="Generate Report">
                                                <i class="fas fa-file-alt"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Insights Summary -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Key Insights & Recommendations
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <h6 class="text-success">
                            <i class="fas fa-thumbs-up me-2"></i>Strengths
                        </h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>High engagement score ({{ "%.1f"|format(insights.engagement_score) }})</li>
                            <li><i class="fas fa-check text-success me-2"></i>Strong learning completion rate ({{ insights.learning_completion_rate }}%)</li>
                            <li><i class="fas fa-check text-success me-2"></i>Diverse department representation</li>
                        </ul>
                    </div>
                    <div class="col-md-4 mb-3">
                        <h6 class="text-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>Areas for Improvement
                        </h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-arrow-right text-warning me-2"></i>Focus on wellness programs</li>
                            <li><i class="fas fa-arrow-right text-warning me-2"></i>Enhance skill development initiatives</li>
                            <li><i class="fas fa-arrow-right text-warning me-2"></i>Improve work-life balance</li>
                        </ul>
                    </div>
                    <div class="col-md-4 mb-3">
                        <h6 class="text-primary">
                            <i class="fas fa-rocket me-2"></i>Action Plan
                        </h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-play text-primary me-2"></i>Launch wellness challenge</li>
                            <li><i class="fas fa-play text-primary me-2"></i>Implement mentorship program</li>
                            <li><i class="fas fa-play text-primary me-2"></i>Regular pulse surveys</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Department Distribution Chart
const deptCtx = document.getElementById('departmentChart').getContext('2d');
const departments = {{ insights.departments | tojsonfilter | safe }};

new Chart(deptCtx, {
    type: 'doughnut',
    data: {
        labels: Object.keys(departments),
        datasets: [{
            data: Object.values(departments),
            backgroundColor: [
                '#007bff',
                '#28a745',
                '#ffc107',
                '#dc3545',
                '#6f42c1',
                '#20c997'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 15,
                    usePointStyle: true
                }
            }
        }
    }
});

// Wellness Distribution Chart
const wellnessCtx = document.getElementById('wellnessChart').getContext('2d');
const wellness = {{ insights.wellness_distribution | tojsonfilter | safe }};

new Chart(wellnessCtx, {
    type: 'bar',
    data: {
        labels: ['Excellent', 'Good', 'Needs Attention'],
        datasets: [{
            data: [wellness.green || 0, wellness.yellow || 0, wellness.red || 0],
            backgroundColor: [
                '#28a745',
                '#ffc107',
                '#dc3545'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Attrition Trends Chart
const attritionCtx = document.getElementById('attritionChart').getContext('2d');
const attritionData = {{ insights.attrition_data | tojsonfilter | safe }};

new Chart(attritionCtx, {
    type: 'line',
    data: {
        labels: attritionData.map(d => d.month),
        datasets: [{
            label: 'Attrition Rate (%)',
            data: attritionData.map(d => d.rate),
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Gender Distribution Chart
const genderCtx = document.getElementById('genderChart').getContext('2d');
const genderData = {{ insights.diversity_stats.gender_distribution | tojsonfilter | safe }};

new Chart(genderCtx, {
    type: 'pie',
    data: {
        labels: Object.keys(genderData),
        datasets: [{
            data: Object.values(genderData),
            backgroundColor: [
                '#007bff',
                '#e83e8c',
                '#6f42c1'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 15,
                    usePointStyle: true
                }
            }
        }
    }
});

// Age Group Distribution Chart
const ageCtx = document.getElementById('ageChart').getContext('2d');
const ageData = {{ insights.diversity_stats.age_groups | tojsonfilter | safe }};

new Chart(ageCtx, {
    type: 'bar',
    data: {
        labels: Object.keys(ageData),
        datasets: [{
            data: Object.values(ageData),
            backgroundColor: [
                '#17a2b8',
                '#28a745',
                '#ffc107',
                '#fd7e14'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 5
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

function showAnalytics(type) {
    // Update active button
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // This would typically load different data sets
    console.log('Showing analytics for:', type);
}
</script>
{% endblock %}
